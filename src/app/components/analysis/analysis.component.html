<div class="analysis-container">
  <div class="analysis-header">
    <div class="header-left">
      <h2>{{ attemptData?.examTitle }}</h2>
      <p class="meta">
        üìÖ {{ attemptData?.submittedAt | date: "medium" }} ‚Ä¢ üéØ
        {{ attemptData?.totalScore }}/720
      </p>
    </div>

    <div class="header-right">
      <button
        mat-stroked-button
        color="primary"
        class="ai-btn"
        (click)="generateAIAnalysis()"
        [disabled]="aiLoading"
      >
        <span *ngIf="!aiLoading">üß† AI Insights</span>
        <span *ngIf="aiLoading">Analyzing...</span>
      </button>
    </div>
  </div>

  <!-- üìä Stats Summary Section -->
  <div class="stats-section" *ngIf="attemptData">
    <div class="stat-card">
      <h4>Total Questions</h4>
      <p>
        {{ attemptData?.totalQuestions || attemptData?.questions?.length || 0 }}
      </p>
    </div>
    <div class="stat-card correct">
      <h4>Correct</h4>
      <p>{{ attemptData?.correctCount }}</p>
    </div>
    <div class="stat-card incorrect">
      <h4>Incorrect</h4>
      <p>{{ attemptData?.wrongCount }}</p>
    </div>
    <div class="stat-card skipped">
      <h4>Skipped</h4>
      <p>{{ attemptData?.skippedCount }}</p>
    </div>
    <div class="stat-card">
      <h4>Accuracy</h4>
      <p>{{ attemptData?.accuracy | number: "1.0-2" }}%</p>
    </div>
  </div>

  <div class="charts-section">
    <div class="chart-card">
      <h3>Overall Accuracy</h3>
      <div class="pie-wrapper">
        <canvas baseChart [data]="pieChartData" [type]="'doughnut'"></canvas>
      </div>
      <!-- <p class="chart-hint">Distribution of your responses</p> -->
    </div>

    <div class="chart-card">
      <h3>Subject-wise Performance</h3>
      <div class="bar-wrapper">
        <canvas
          baseChart
          [data]="barChartData"
          [options]="barChartOptions"
          [type]="'bar'"
        ></canvas>
      </div>
      <!-- <p class="chart-hint">Accuracy across subjects</p> -->
    </div>
  </div>

  <div class="insights-card" *ngIf="insights.length">
    <h3>Insights üß†</h3>
    <ul>
      <li *ngFor="let i of insights" [ngClass]="i.type">
        {{ i.message }}
      </li>
    </ul>
  </div>

  <div class="ai-analysis-card" *ngIf="aiAnalysis">
    <h3>AI Performance Insights ü§ñ</h3>

    <p class="ai-summary">
      {{ aiAnalysis.summary }}
    </p>

    <div *ngIf="aiAnalysis.strengths?.length">
      <h4>‚úÖ Strengths</h4>
      <ul>
        <li *ngFor="let s of aiAnalysis.strengths">{{ s }}</li>
      </ul>
    </div>

    <div *ngIf="aiAnalysis.improvements?.length">
      <h4>‚ö† Areas to Improve</h4>
      <ul>
        <li *ngFor="let i of aiAnalysis.improvements">{{ i }}</li>
      </ul>
    </div>

    <div *ngIf="aiAnalysis.recommendations?.length">
      <h4>üéØ Recommendations</h4>
      <ul>
        <li *ngFor="let r of aiAnalysis.recommendations">{{ r }}</li>
      </ul>
    </div>
  </div>

  <div class="questions-section">
    <h3>Question Analysis</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Question</th>
          <th>Your Answer</th>
          <th>Correct Answer</th>
          <th>Status</th>
          <th>Time Spent</th>
          <!-- ‚è±Ô∏è Added -->
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let q of attemptData?.questions; index as i">
          <td>{{ i + 1 }}</td>
          <td>{{ q.questionText }}</td>
          <td>
            {{
              q.selectedOptionIndex !== null &&
              q.selectedOptionIndex !== undefined
                ? q.selectedOptionIndex
                : "-"
            }}
          </td>
          <td>{{ q.correctOptionIndex }}</td>
          <td
            *ngIf="
              q.selectedOptionIndex === null ||
              q.selectedOptionIndex === undefined
            "
            class="skipped"
          >
            ‚è© Skipped
          </td>
          <td
            *ngIf="
              q.selectedOptionIndex !== null &&
              q.selectedOptionIndex !== undefined
            "
            [class.correct]="q.isCorrect"
            [class.incorrect]="!q.isCorrect"
          >
            {{ q.isCorrect ? "‚úîÔ∏è" : "‚ùå" }}
          </td>
          <td>{{ q.timeSpent ? q.timeSpent + "s" : "--" }}</td>
          <!-- ‚è±Ô∏è Added fallback -->
        </tr>
      </tbody>
    </table>
  </div>

  <button mat-raised-button color="primary" (click)="backToResults()">
    Back to Results
  </button>
</div>
